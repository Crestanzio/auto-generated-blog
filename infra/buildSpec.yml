# testing codebuild webhook

version: 0.2

phases:
  install:
    commands:
      - export IMAGE_TAG="latest"
      - export BACKEND=$ECR_URI/backend
      - export FRONTEND=$ECR_URI/frontend
      - export FRONTEND_HOST=$FRONTEND_HOST
      - export FRONTEND_PORT=$FRONTEND_PORT
      - export BACKEND_HOST=$BACKEND_HOST
      - export BACKEND_PORT=$BACKEND_PORT
      - export VITE_API_URL=$VITE_API_URL
      - export ARTICLE_JOB=$ARTICLE_JOB
      - export HF_TOKEN=$HF_TOKEN

      - echo Install phase, ensure aws cli available
      - command -v aws || (echo "'AWS cli' not found. Please install it"; exit 1)
      - echo aws --version
      - echo docker --version
  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_URI
  build:
    commands:
      - echo "Building images..."
      - docker compose -f infra/docker-compose.yml build

  post_build:
    commands:
      - echo "Pushing images to ECR..."
      - docker compose -f infra/docker-compose.yml push
      - echo "Images pushed successfully."